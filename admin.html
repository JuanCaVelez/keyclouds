<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - KeyClouds</title>
    <link rel="stylesheet" href="styles/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .image-upload-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .image-slot {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }

        .image-slot.has-image {
            border-color: #836b9d;
            border-style: solid;
        }

        .image-slot-preview {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            display: none;
        }

        .image-slot.has-image .image-slot-preview {
            display: block;
        }

        .image-slot-placeholder {
            width: 70px;
            height: 70px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 24px;
        }

        .image-slot.has-image .image-slot-placeholder {
            display: none;
        }

        .image-slot-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .image-slot-label {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }

        .image-slot-url {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-upload {
            background-color: #836b9d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: background-color 0.3s;
        }

        .btn-upload:hover {
            background-color: #6a5580;
        }

        .btn-remove-image {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            transition: transform 0.2s;
        }

        .btn-remove-image:hover {
            transform: scale(1.2);
        }

        .upload-hint {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <h1>KeyClouds</h1>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="index.html#productos">Productos</a></li>
                <li><a href="admin.html" class="active">Admin</a></li>
            </ul>
            <div class="admin-user-menu">
                <span class="admin-username">
                    <i class="fa-solid fa-user-shield"></i>
                    <span id="currentUser">Admin</span>
                </span>
                <button onclick="handleLogout()" class="btn-logout" title="Cerrar Sesión">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    Salir
                </button>
            </div>
        </nav>
    </header>

    <section class="admin-section">
        <h2>Panel de Administración</h2>

        <div class="admin-form-container">
            <h3 id="formTitle">Agregar Nuevo Producto</h3>

            <form id="productForm" class="product-form">
                <input type="hidden" id="productId">

                <div class="form-group">
                    <label for="productName">Nombre del Producto *</label>
                    <input type="text" id="productName" required>
                </div>

                <div class="form-group">
                    <label for="productCategory">Categoría *</label>
                    <select id="productCategory" required>
                        <option value="">Selecciona una categoría</option>
                    </select>
                    <small>Selecciona la categoría del producto</small>
                </div>

                <div class="form-group">
                    <label for="productPrice">Precio *</label>
                    <input type="text" id="productPrice" required placeholder="15.00">
                </div>

                <!-- IMÁGENES CON UPLOAD -->
                <div class="form-group">
                    <label>Imágenes del producto * (máximo 3 colores)</label>
                    <div class="image-upload-group">

                        <div class="image-slot" id="slot-0">
                            <img class="image-slot-preview" id="preview-0" src="" alt="Color 1">
                            <div class="image-slot-placeholder"><i class="fa-solid fa-image"></i></div>
                            <div class="image-slot-info">
                                <span class="image-slot-label">Color 1 *</span>
                                <span class="image-slot-url" id="url-label-0">Sin imagen</span>
                            </div>
                            <button type="button" class="btn-upload" onclick="openUploadWidget(0)">
                                <i class="fa-solid fa-upload"></i> Subir
                            </button>
                            <button type="button" class="btn-remove-image" onclick="removeImage(0)">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>

                        <div class="image-slot" id="slot-1">
                            <img class="image-slot-preview" id="preview-1" src="" alt="Color 2">
                            <div class="image-slot-placeholder"><i class="fa-solid fa-image"></i></div>
                            <div class="image-slot-info">
                                <span class="image-slot-label">Color 2</span>
                                <span class="image-slot-url" id="url-label-1">Sin imagen</span>
                            </div>
                            <button type="button" class="btn-upload" onclick="openUploadWidget(1)">
                                <i class="fa-solid fa-upload"></i> Subir
                            </button>
                            <button type="button" class="btn-remove-image" onclick="removeImage(1)">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>

                        <div class="image-slot" id="slot-2">
                            <img class="image-slot-preview" id="preview-2" src="" alt="Color 3">
                            <div class="image-slot-placeholder"><i class="fa-solid fa-image"></i></div>
                            <div class="image-slot-info">
                                <span class="image-slot-label">Color 3</span>
                                <span class="image-slot-url" id="url-label-2">Sin imagen</span>
                            </div>
                            <button type="button" class="btn-upload" onclick="openUploadWidget(2)">
                                <i class="fa-solid fa-upload"></i> Subir
                            </button>
                            <button type="button" class="btn-remove-image" onclick="removeImage(2)">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>

                    </div>
                    <small class="upload-hint">Sube una imagen por cada color disponible del producto.</small>
                </div>

                <div class="form-group">
                    <label for="productLink">Enlace de Compra (WhatsApp) *</label>
                    <input type="url" id="productLink" readonly value="https://wa.me/+593980467248" required>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="btn-primary">
                        <i class="fa-solid fa-save"></i> Guardar Producto
                    </button>
                    <button type="button" onclick="cancelEdit()" class="btn-secondary">
                        <i class="fa-solid fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>

        <div class="admin-products-list">
            <h3>Productos Registrados</h3>
            <div id="adminProductsList"></div>
        </div>
    </section>

    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="script/auth.js"></script>
    <script type="module">
        import "./script/admin.js";
    </script>

    <script>
        requireAuth();

        const session = getSessionData();
        if (session) {
            document.getElementById('currentUser').textContent = session.username;
        }

        function handleLogout() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                logout();
            }
        }

        // URLs de imágenes en memoria
        window.productImages = ['', '', ''];

        // Abrir Cloudinary Upload Widget
        window.openUploadWidget = function(slotIndex) {
            const widget = cloudinary.createUploadWidget(
                {
                    cloudName: 'images-tienda',
                    uploadPreset: 'keyclouds_preset',
                    multiple: false,
                    maxFiles: 1,
                    resourceType: 'image',
                    clientAllowedFormats: ['jpg', 'jpeg', 'png', 'webp'],
                    maxFileSize: 5000000,
                    cropping: false,
                    sources: ['local', 'camera'],
                    language: 'es'
                },
                (error, result) => {
                    if (!error && result && result.event === 'success') {
                        const url = result.info.secure_url;
                        setImageSlot(slotIndex, url);
                        widget.close();
                    }
                }
            );
            widget.open();
        };

        // Asignar imagen a un slot
        window.setImageSlot = function(index, url) {
            window.productImages[index] = url;
            const slot = document.getElementById(`slot-${index}`);
            const preview = document.getElementById(`preview-${index}`);
            const urlLabel = document.getElementById(`url-label-${index}`);
            preview.src = url;
            urlLabel.textContent = url.split('/').pop();
            slot.classList.add('has-image');
        };

        // Quitar imagen de un slot
        window.removeImage = function(index) {
            window.productImages[index] = '';
            const slot = document.getElementById(`slot-${index}`);
            const preview = document.getElementById(`preview-${index}`);
            const urlLabel = document.getElementById(`url-label-${index}`);
            preview.src = '';
            urlLabel.textContent = 'Sin imagen';
            slot.classList.remove('has-image');
        };

        setInterval(() => {
            const timeRemaining = getSessionTimeRemaining();
            if (timeRemaining <= 5 && timeRemaining > 0) {
                console.warn(`Tu sesión expirará en ${timeRemaining} minutos`);
            }
        }, 60000);
    </script>
</body>
</html>