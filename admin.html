<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Admin - KeyClouds</title>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <h1>KeyClouds</h1>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="index.html#productos">Productos</a></li>
                <li><a href="admin.html" class="active">Admin</a></li>
            </ul>
            <div class="search-box">
                <a href="index.html" class="back-btn">
                    <i class="fa-solid fa-arrow-left"></i> Volver
                </a>
            </div>
        </nav>
    </header>
    
    <section class="admin-section">
        <h2>Panel de Administración</h2>
        
        <!-- Formulario para agregar/editar productos -->
        <div class="admin-form-container">
            <h3 id="formTitle">Agregar Nuevo Producto</h3>
            <form id="productForm" class="product-form">
                <input type="hidden" id="productId" value="">
                
                <div class="form-group">
                    <label for="productName">Nombre del Producto *</label>
                    <input type="text" id="productName">
                </div>
                
                <div class="form-group">
                    <label for="productPrice">Precio *</label>
                    <input type="text" id="productPrice">
                </div>
                
                <div class="form-group">
                    <label for="productImage">Imagen del Producto *</label>
                    <input type="file" id="productImage" accept="image/*">
                    <small>Formatos aceptados: JPG, PNG, GIF</small>
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                
                <div class="form-group">
                    <label for="productLink">Enlace de Compra *</label>
                    <input type="url" id="productLink">
                </div>
                
                <div class="form-buttons">
                    <button type="submit" class="btn-primary">
                        <i class="fa-solid fa-save"></i> Guardar Producto
                    </button>
                    <button type="button" onclick="cancelEdit()" class="btn-secondary">
                        <i class="fa-solid fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Lista de productos -->
        <div class="admin-products-list">
            <h3>Productos Registrados</h3>
            <div id="adminProductsList">
                <!-- Los productos se cargarán aquí -->
            </div>
        </div>
    </section>
    
    <footer>
        <div class="footer-content">
            <p>&copy; 2024 KeyClouds. All rights reserved.</p>
            <div class="social-media">
                <a href="#" aria-label="WhatsApp">
                    <i class="fa-brands fa-whatsapp"></i> WhatsApp
                </a>
                <a href="#" aria-label="Instagram">
                    <i class="fa-brands fa-instagram"></i> Instagram
                </a>
                <a href="#" aria-label="TikTok">
                    <i class="fa-brands fa-tiktok"></i> TikTok
                </a>
            </div>
        </div>
    </footer>

    <script src="script/products.js"></script>
    <script>
        let editingProductId = null;

        // Cargar productos al iniciar
        displayAdminProducts();

        // Preview de imagen
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Manejar envío del formulario
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveProduct();
        });

        function saveProduct() {
            const nameElement = document.getElementById('productName');
            const priceElement = document.getElementById('productPrice');
            const linkElement = document.getElementById('productLink');
            const imageElement = document.getElementById('productImage');
            const productIdElement = document.getElementById('productId');

            if (!nameElement || !priceElement || !linkElement || !imageElement || !productIdElement) {
                console.error('Uno o más elementos del formulario no se encontraron');
                return;
            }

            const name = nameElement.value;
            const price = priceElement.value;
            const link = linkElement.value;
            const imageFile = imageElement.files[0];
            const productId = productIdElement.value || null;

            // Validaciones
            if (!name || !price || !link) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }

            // Si estamos editando y no hay nueva imagen, mantener la anterior
            if (editingProductId && !imageFile) {
                const products = getProducts();
                const existingProduct = products.find(p => p.id === editingProductId);
                const product = {
                    id: editingProductId,
                    name: name,
                    price: price,
                    image: existingProduct.image,
                    link: link
                };
                updateProduct(editingProductId, product);
                resetForm();
                displayAdminProducts();
                return;
            }

            // Si hay nueva imagen
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const product = {
                        id: editingProductId || Date.now().toString(),
                        name: name,
                        price: price,
                        image: event.target.result,
                        link: link
                    };

                    if (editingProductId) {
                        updateProduct(editingProductId, product);
                    } else {
                        addProduct(product);
                    }

                    resetForm();
                    displayAdminProducts();
                };
                reader.readAsDataURL(imageFile);
            } else if (!editingProductId) {
                alert('Por favor selecciona una imagen para el producto');
            }
        }

        function editProduct(id) {
            const products = getProducts();
            const product = products.find(p => p.id === id);
            
            if (product) {
                editingProductId = id;
                document.getElementById('productId').value = id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productLink').value = product.link;
                document.getElementById('imagePreview').innerHTML = `<img src="${product.image}" alt="Preview">`;
                document.getElementById('formTitle').textContent = 'Editar Producto';
                document.querySelector('.admin-form-container').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function confirmDelete(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este producto?')) {
                deleteProduct(id);
                displayAdminProducts();
            }
        }

        function cancelEdit() {
            resetForm();
        }

        function resetForm() {
            editingProductId = null;
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('formTitle').textContent = 'Agregar Nuevo Producto';
        }
    </script>
</body>
</html>